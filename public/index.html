<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>International Patient Summary</title>
        <meta name="description" content="International Patient Summary in a digital wallet">
        <meta name="author" content="Findynet">
        <link rel="stylesheet" href="styles.css">
        <link rel="icon" href="favicon.png">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="width">
        <meta property="og:type" content="website">
        <meta property="og:title" content="International Patient Summary">
        <meta property="og:url" content="https://ips-demo.trustregistry.eu/">
        <meta property="og:image" content="https://ips-demo.trustregistry.eu/favicon.png">
        <meta property="og:description" content="International Patient Summary in a digital wallet">
        <script src="qrcode.min.js"></script>
    </head>
    <body>
        <header>
            <div id="box">
                <img class="logo" src="favicon.png" alt="IPS Logo">
            </div>
            <h1 lang="en">International Patient Summary demo</h1>
        </header>
        <main>
            <!-- Introduction Card -->
            <div class="card" id="intro-card">
                <div id="instructions">
                    <h2 class="card-title" lang="en">About This Service</h2>
                    <p lang="en">This service allows you to obtain your <a href="https://international-patient-summary.net/" target="_blank" rel="noopener">International Patient Summary</a> as a digital credential in your wallet.</p>
                    <p lang="en">Choose one of the options below to get started:</p>
                </div>
            </div>

            <!-- Two Options Container -->
            <div class="options-container" id="options-container">
                <!-- Option A: Epic Integration -->
                <div class="option-card epic-section">
                    <div class="option-label" lang="en">Option A</div>
                    <h3 class="option-title" lang="en">Connect to Epic</h3>
                    <p class="option-description" lang="en">Log in to the Epic on FHIR sandbox to automatically fetch your patient data.</p>
                    <button type="button" id="epic"><span lang="en">Get your Epic Patient Data</span></button>
                    <table lang="en">
                        <caption lang="en">Sandbox <a href="https://fhir.epic.com/Documentation?docId=testpatients" target="_blank" rel="noopener">Test Users</a></caption>
                        <thead>
                            <tr><th lang="en">Username</th><th lang="en">Password</th></tr>
                        </thead>
                        <tbody>
                            <tr><td lang="en">fhircamila</td><td lang="en">epicepic1!</td></tr>
                            <tr><td lang="en">fhirderrick</td><td lang="en">epicepic1!</td></tr>
                            <tr><td lang="en">fhirdesiree</td><td lang="en">epicepic1!</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Option B: Manual Entry -->
                <div class="option-card">
                    <div class="option-label" lang="en">Option B</div>
                    <h3 class="option-title" lang="en">Use IPS Bundle</h3>
                    <p class="option-description" lang="en">Test using the pre-filled sample IPS bundle, or paste your own IPS data below.</p>
                    <form id="form">
                        <input type="hidden" name="protocol" id="protocol" value="OPENID4VCI_FINAL1">
                        <label for="content" lang="en">IPS Bundle Content:</label>
                        <textarea name="content" id="content" rows="12" cols="50"></textarea>
                        <button type="button" id="load"><span lang="en">Create Digital Credential</span></button>
                    </form>
                </div>
            </div>

            <!-- QR Code Display Area -->
            <div id="qrcode"></div>
        </main>
        <footer>
            <p lang="en">Created by <a href="https://findynet.com" target="_blank" rel="noopener">Findynet</a> in the <a href="https://fhir.fi/hackathon/2026/finland/patient-access" target="_blank" rel="noopener">Patient Access Track</a> in the <a href="https://fhir.fi/hackathon/2026/finland" target="_blank" rel="noopener">Finnish Health Data hackathon</a>.</p>
            <p>See <a href="benefits.html">Benefits of the solution and a demo video</a>.</p>
            <p lang="en">The source code is available on <a href="https://github.com/FindyFi/ips-demo" target="_blank" rel="noopener">GitHub</a>.</p>
            <p lang="en">This service is a technical demonstration. It should not be used for real patient data. The service does not store any data but some information may remain in technical log files.</p>
        </footer>
        <script>

            const ips_bundle = './IPS_IG-bundle-01.json'

            const f = document.getElementById('form')
            const l = document.getElementById('box')
            const o = document.getElementById('instructions')
            const optionsContainer = document.getElementById('options-container')
            const introCard = document.getElementById('intro-card')
            const instructions = o.innerHTML

            document.getElementById('load').addEventListener('click', async () => {
                const issueUrl = '/issue'
                const issueParams = {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: document.getElementById('content').value,
                        protocol: document.getElementById('protocol').value
                    })
                }
                const response = await fetch(issueUrl,  issueParams)
                const respJson = await response.json()
                if (!respJson.url) {
                    alert('Error: ' + respJson.error)
                }
                else {
                    qrcode = new QRCode("qrcode", { width: 256, height: 256 })
                    qrcode.makeCode(respJson.url)
                    l.classList.toggle('opened')
                    o.innerHTML = '<p lang="en">Scan the QR code with your wallet.</p>' +
                        '<p lang="en">Download the Procivis One wallet:</p>' + '<p>' +
                        '<a target="_blank" href="https://play.google.com/store/apps/details?id=ch.procivis.one.wallet.trial&pli=1">Android</a>' +
                        ' | ' +
                        '<a target="_blank" href="https://apps.apple.com/us/app/procivis-one-wallet/id6480111491">iOS</a>' +
                        '</p>'
/*
                    const a = document.createElement('a')
                    a.lang = 'fi'
                    a.href = 'https://ips-verifier.sensotrend.fi/'
                    a.className = 'block'
                    a.textContent = "Go to Sensotrend IPS Verifier"
                    o.appendChild(a)
*/
                    const qrDiv = document.getElementById('qrcode')
                    const back = document.createElement('a')
                    back.lang = 'en'
                    back.textContent = "Return"
                    back.className = 'block'
                    back.onclick = () => { 
                        qrDiv.innerHTML = ''
                        l.classList.toggle('opened')
                        optionsContainer.style.display = ''
                        o.innerHTML = instructions
                    }
                    o.appendChild(back)
                    const img = qrDiv.querySelector('img')
                    if (img) {
                        const a = document.createElement('a')
                        a.href = respJson.url
                        qrDiv.appendChild(a)
                        a.appendChild(img)
                    }
                    optionsContainer.style.display = 'none'
                }
            })

            document.getElementById('epic').addEventListener('click', async () => {
                const loginUrl = await fetch('/epicurl').then(res => res.json())
                if (loginUrl.url) {
                    window.open(loginUrl.url, '_blank')
                } else {
                    alert('Error getting Epic login URL')
                }
            })

            window.addEventListener("message", (event) => {
                if (event.data) {
                    console.log("Received message:", event.data);
                    document.getElementById('content').value = JSON.stringify(event.data, null, 2)
                    document.getElementById('load').click()
                }
            }, false);

            window.onload = () => {
                const bundle = fetch(ips_bundle)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('content').value = JSON.stringify(data, null, 2)
                    })
            }
        </script>
    </body>
</html>